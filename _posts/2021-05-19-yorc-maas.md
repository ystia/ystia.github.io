---
title:  "YORC now support MAAS as a location"
tags: ['index', 'Yorc', 'baremetal', 'MAAS']
---

The Ystia Orchestrator (Yorc) now support bare-metal clusters.  
To achieve this, MAAS is used as a provider using its API.

# MAAS as a new location

[MAAS](https://maas.io/) (Metal as a Service) is a self hosted open source framework developed by Canonical capable of managing a cluster of bare metals machines.  
To achieve this, MAAS gives you automated server provisioning and easy network setup for your physical servers.  

It's key points features are: 
- Inventory capacities, it will scan for any hardware and even discover every PCI and USB device
- Fast install of any OS on a specific machine.
- API driven 
- Hardware testing, extremely useful to monitor hardware health

MAAS has a Cloud like experience. It lets you treat physical servers like virtual machines in the cloud. So rather than having to manage each server individually, MAAS turns your bare metal into an elastic cloud-like resource.

Using Hostpool, it was already possible to use a group of physical nodes as a deployemeny infrastructure with YORC.  
But with MAAS integration, the management of such infrastructure is much more practical and powerful. The OS installations are automated and it's way more easier to manage machines.   

# How to try this (Requirements)
Obsiously a MAAS cluster is needed. To quickly test, MAAS provide a environment with all MAAS components on a single host.  
For more information about this [check this](https://maas.io/docs/snap/2.9/ui/installation).  
The non virtual way to try it, is to install MAAS on one small server and have at least one server which can be managed with a BMC.  

Once you have a running MAAS instance with at least one machine with the "Ready" status, you can continue.  

## MAAS configuration
### Yorc configuration
When adding a **maas** location in Yorc, two configuration properties are mandatory:  

**api_url**  
It's the url and port of the maas service. It can be http://192.168.80.22:5240/MAAS/

**api_key**
It's the user API key given by MAAS. It can be found when clicking the username then "API key" in MAAS UI. This key will be use for API authentification.  

A key pair (RSA like) will be needed and will be used as a way to connect to the deployed nodes with SSH. The private key must be available in the YORC host (in ~/.ssh/). The public will be installed by MAAS in the deployed nodes. 
To import the public key in MAAS, on the UI click on your username, then "SSH key".   
If it's not done YORC won't be able to connect to the machine after the deployement, this could lead to issues.  

### Internet access
By default, MAAS use a built-in proxy, this allow provisioned machines to use APT and YUM to install packages without any specific configuration.      
But if any HTTP access is required, to download a GIT repo for example, more configuration are needed.  
One possiblity is to use the built-in proxy too, with HTTP_PROXY and HTTPS_PROXY env variable on port 8000. For more informations about this [check this](https://maas.io/docs/snap/2.9/ui/proxy).    

Antoher way to allow HTTP trafic, is to configure a gateway. For this, in the "Subnets" menu, you must declare a gateway ip for a subnet. 
After that, all provisioned machines in the subnet will have the gateway ip as default route. Then you must configure the gateway machine as a router.    
This probably mean enabling IP forwarding with **(sysctl -w net.ipv4.ip_forward=1)**. And enable NAT on the gateway network configuration, this could be done with something like **iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE**. 

The last final step to ensure full internet access, is to correctly set up the DNS. MAAS server can forward DNS request. In "settings -> network -> DNS" you can provide the upstream DNS to resolve internet domains.  
In case of DNS malfunction, it may be required to disable DNSSEC, an option available in this menu too.  

## MAAS Compute supported properties
List of supported properties : distro_series, arch, erase, secure_erase, quick_erase, tags, not_tags  
For more information about the specific effect of these properties, [check this](https://maas.io/docs/api). The specific endpoints to check are **POST /MAAS/api/2.0/machines/?op=allocate** and **POST /MAAS/api/2.0/machines/{system_id}/?op=deploy**

Once you have a valid topology with a MAAS compute Node, when you will deploy it with YORC, MAAS will acquire a node and install the OS specified in the deployement. Now you can enjoy the power of a bare metal clusters with a cloud like experience !   

